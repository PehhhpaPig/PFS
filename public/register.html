<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="css/style.css">
<title>Sign Up – 2‑Factor Required</title>
<style>

 #qrStage{display:none;text-align:left}

</style>
</head>
<body>
<div class="container">
<h1>Create Account</h1>

<!-- STEP 1 -->
<form id="credsForm">
  <label>Username
    <input name="username" required pattern=".{3,32}" autocomplete="off">
  </label>
  <label>Password
    <input type="password" name="password" required autocomplete="off" minlength="8" pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^a-zA-Z0-9]).{8,}"
    title="Must include uppercase, lowercase, a number, and a symbol">
  </label>
  <label>Confirm Password
    <input type="password" name="confirm" autocomplete="off" required minlength="8">
  </label>
  <button>Next: Scan QR</button>
</form>

<!-- STEP 2 -->
<div id="qrStage">
  <h2>Scan with Google / Microsoft Authenticator</h2>
  <div id="qrBox" class="text-center" style="margin: 1rem 0;"></div>
  <form id="codeForm">
    <label>Enter first 6‑digit code
      <input name="code"
             pattern="[0-9]{6}"
             maxlength="6" minlength="6"
             placeholder="123456"
             required autocomplete="off">
    </label>
    <button>Verify & Finish</button>
  </form>
</div>

<p id="msg" class="alert" style="margin-top: 1.5rem;"></p>
</div>

<!-- local QR generator -->
<script src="../public/js/qrcode.js"></script>
<script type="module">
const api = async fd => (await fetch('../api/auth/register.php',{
  method:'POST',credentials:'include',body:fd,headers:{'Accept':'application/json'}
})).json();

const $ = id=>document.getElementById(id), msg=$('msg');

$('credsForm').addEventListener('submit',async e=>{
  e.preventDefault(); msg.textContent='Creating account…';
  const out=await api(new FormData(e.target));
  if(out.error){msg.textContent='❌ '+out.error;return;}
  // draw QR locally
  new QRCode($('qrBox'), {text:out.uri,width:200,height:200});
  e.target.style.display='none'; $('qrStage').style.display='block'; msg.textContent='';
});

$('codeForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const out=await api(new FormData(e.target));
  if(out.error){msg.textContent='❌ '+out.error;return;}
  msg.innerHTML='✅ Account created. <a href="index.html">Log in</a>';
});
</script>
</body>
</html>
