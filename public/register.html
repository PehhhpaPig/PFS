<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="css/style.css">
<title>Sign Up – 2‑Factor Required</title>
<style>
 #qrStage{display:none;text-align:center}
 #msg{margin-top:1rem}
</style>
</head>
<body>


<!-- STEP 1 -->
<div>
  <form id="credsForm" role="form" novalidate>
  <h1>Create Account</h1>
  <div id="passfeilds">
    <div style="height: 2rem;"></div>
    <input name="username" placeholder="Username" pattern=".{3,32}">
    <br>
    <input type="password" placeholder="Password" name="password" required minlength="8">
    <br>
    <input type="password" placeholder="Confirm Password" name="confirm" required minlength="8">
    <br>
  </div> 
  <button>Next: Scan QR</button>
  </form>
</div>

<!-- STEP 2 -->
<div id="qrStage">
  <h2>Scan with Google / Microsoft Authenticator</h2>
  <div id="qrBox"></div>
  <form id="codeForm">
    <label>Enter first 6‑digit code
      <input name="code"
             pattern="[0-9]{6}"
             maxlength="6" minlength="6"
             placeholder="123456"
             required>
    </label>
    <button>Verify & Finish</button>
  </form>
</div>

<p id="msg"></p>

<!-- local QR generator -->
<script src="../public/js/qrcode.js"></script>
<script type="module">
  const api = async fd => (await fetch('../api/auth/register.php',{
  method:'POST',
  credentials:'include',
  body:fd,
  headers:{'Accept':'application/json'}
})).json();

const $ = id=>document.getElementById(id), msg=$('msg');

$('credsForm').addEventListener('submit',async e=>{
  e.preventDefault(); 
  msg.textContent='Creating account…';
  
  const out=await api(new FormData(e.target));

  if(out.error){
    msg.textContent='❌ '+out.error;
    return;
  }
  console.log('API response:', out);
  
  msg.innerHTML='✅ Account created. <a href="index.html">Log in</a>';
  // draw QR locally
  new QRCode($('qrBox'), {text:out.uri,width:200,height:200});
  e.target.style.display='none'; 
  $('qrStage').style.display='block'; 
  msg.textContent='';
});
$('codeForm').addEventListener('submit',async e=>{
  e.preventDefault(); 
  msg.textContent='Verifying…';
  
  const out=await api(new FormData(e.target));

  if(out.error){
    msg.textContent='❌ '+out.error;
    return;
  }
  console.log('API response:', out);
  
  msg.innerHTML='✅ Account created. <br><a href="index.html">Log in</a>';
});
</script>
</body>
</html>
